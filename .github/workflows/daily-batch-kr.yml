name: KR Market Daily Update
# ì„¤ëª…: í•œêµ­ ì‹œì¥(KOSPI, KOSDAQ) ì „ìš© ë°ì¼ë¦¬ ì—…ë°ì´íŠ¸ (ë§¤ì¼ í•œêµ­ì‹œê°„ 18:00 ì‹¤í–‰)

on:
  schedule:
    - cron: '0 9 * * *' # UTC 09:00 = KST 18:00
  workflow_dispatch:

jobs:
  kr-daily-routine:
    runs-on: ubuntu-latest
    steps:
      - name: Wake up Server
        run: curl https://quantgravity-backend.onrender.com/
      
      # 1. í•œêµ­ ì£¼ê°€ ì—…ë°ì´íŠ¸
      - name: KR Stock Stock Price Update
        timeout-minutes: 15
        run: |
          echo "ğŸš€ [KR] í•œêµ­ ì‹œì¥ ì£¼ê°€ ì—…ë°ì´íŠ¸ ì‹œì‘..."
          curl -X POST https://quantgravity-backend.onrender.com/api/fmp/daily-update-all \
          -H "Content-Type: application/json" \
          -H "x-batch-key: ${{ secrets.BATCH_SECRET_KEY }}" \
          -d '{"days": 3, "market": "KR"}'

      # [ì¶”ê°€í•  ë¶€ë¶„] 5ë¶„(300ì´ˆ) ëŒ€ê¸°í•˜ì—¬ ë°±ê·¸ë¼ìš´ë“œ ë°ì´í„° ì €ì¥ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
      - name: Wait for DB Sync
        run: sleep 300

      # 2. ë§ˆì¼“ë§µ/í†µê³„ ê°±ì‹  (í•œêµ­ì¥ ë°˜ì˜)   
      - name: Update Market Stats
        run: |
          echo "ğŸ“Š [KR] í•œêµ­ ì‹œì¥ í†µê³„ ì§‘ê³„ ì‹œì‘..."
          curl -X POST https://quantgravity-backend.onrender.com/api/batch/update-stats \
          -H "Content-Type: application/json" \
          -H "x-batch-key: ${{ secrets.BATCH_SECRET_KEY }}" \
          -d '{"country": "KR"}'