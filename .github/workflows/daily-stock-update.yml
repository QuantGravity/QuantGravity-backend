name: Daily Stock Price Update

on:
  schedule:
    # 0 23 * * * = UTC 23:00 = í•œêµ­ ì‹œê°„ ì˜¤ì „ 8ì‹œ (ë¯¸êµ­ ì¥ ë§ˆê° í›„)
    - cron: '0 23 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

jobs:
  update-stock:
    runs-on: ubuntu-latest
    timeout-minutes: 15 # ì‘ì—…ì´ ê¸¸ì–´ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ íƒ€ì„ì•„ì›ƒ ë„‰ë„‰íˆ ì„¤ì •
    steps:
      - name: Wake up Server & Update Stock Prices
        run: |
          echo "ğŸš€ Starting Daily Stock Price Update..."
          
          # 1. ì£¼ê°€ ë°ì´í„° ìµœì‹ í™” (ì–´ì œ ë‚ ì§œ í•˜ë£¨ì¹˜ë§Œ ê°€ì ¸ì˜´)
          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST "https://quant-navigator-backend.onrender.com/api/update-prices" \
            -H "Content-Type: application/json" \
            -d '{}')

          if [ "$response" -ne 200 ]; then
            echo "âŒ Failed to update prices. HTTP Status: $response"
            exit 1
          else
            echo "âœ… Stock Prices Update Requested Successfully."
          fi

      - name: Wait for DB Consistency
        run: sleep 30 # DB ì“°ê¸° ì‘ì—…ì´ ì•ˆì •í™”ë  ë•Œê¹Œì§€ ì ì‹œ ëŒ€ê¸°

      - name: Analyze All Tickers
        run: |
          echo "ğŸ§  Starting Batch Analysis..."
          
          # 2. ì „ì²´ ì¢…ëª© ë¶„ì„ ë° ìŠ¤ëƒ…ìƒ· ìƒì„±
          curl -X POST "https://quant-navigator-backend.onrender.com/api/batch/analyze-all-tickers" \
            -H "Content-Type: application/json" \
            -d '{}'
