name: US Market Daily Update
# ì„¤ëª…: ë¯¸êµ­ ì‹œì¥ ì „ìš© (ë§¤ì¼ í•œêµ­ì‹œê°„ ì•„ì¹¨ 9ì‹œ ì‹¤í–‰)

on:
  schedule:
    - cron: '0 0 * * *' # UTC 00:00 = KST 09:00 (ë¯¸êµ­ ì¥ ë§ˆê° 3ì‹œê°„ í›„)
  workflow_dispatch:

jobs:
  us-daily-routine:
    runs-on: ubuntu-latest
    steps:
      - name: Wake up Server
        run: curl https://quantgravity-backend.onrender.com/

      # 1. ë§ˆìŠ¤í„° ë™ê¸°í™” (ë¯¸êµ­ ìœ„ì£¼)
      # [ìˆ˜ì •] Authorization í—¤ë” ëŒ€ì‹  x-batch-keyë¡œ í†µì¼!
      - name: Sync Master Data
        run: |
          curl -X POST https://quantgravity-backend.onrender.com/api/fmp/sync-index-master \
          -H "Content-Type: application/json" \
          -H "x-batch-key: ${{ secrets.BATCH_SECRET_KEY }}"

      # 2. ë¯¸êµ­ ì£¼ê°€ ì—…ë°ì´íŠ¸ (US íŒŒë¼ë¯¸í„° ì „ë‹¬)   
      # [í™•ì¸] ì—¬ê¸°ëŠ” ì•„ì£¼ ì˜ ì‘ì„±í–ˆì–´!
      - name: US Stock Price Update
        timeout-minutes: 15
        run: |
          echo "ğŸš€ [US] ë¯¸êµ­ ì‹œì¥ ì£¼ê°€ ì—…ë°ì´íŠ¸ ì‹œì‘..."
          curl -X POST https://quantgravity-backend.onrender.com/api/fmp/daily-update-all \
          -H "Content-Type: application/json" \
          -H "x-batch-key: ${{ secrets.BATCH_SECRET_KEY }}" \
          -d '{"days": 3, "market": "US"}' 

      # 3. í†µê³„ ê°±ì‹ 
      # [ìˆ˜ì •] ì—¬ê¸°ë„ x-batch-key í—¤ë” í•„ìˆ˜ ì¶”ê°€!  
      - name: Update Market Stats
        run: |
          curl -X POST https://quantgravity-backend.onrender.com/api/batch/update-stats \
          -H "Content-Type: application/json" \
          -H "x-batch-key: ${{ secrets.BATCH_SECRET_KEY }}"