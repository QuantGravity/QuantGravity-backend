name: US Market Daily Update
# ì„¤ëª…: ë¯¸êµ­ ì‹œì¥ ì „ìš© (ë§¤ì¼ í•œêµ­ì‹œê°„ ì•„ì¹¨ 9ì‹œ ì‹¤í–‰)

on:
  schedule:
    - cron: '0 0 * * *' # UTC 00:00 = KST 09:00
  workflow_dispatch:

jobs:
  us-daily-routine:
    runs-on: ubuntu-latest
    steps:
      - name: Wake up Server
        run: curl https://quantgravity-backend.onrender.com/ 

      # 1. ë§ˆìŠ¤í„° ë™ê¸°í™” (ì¢…ëª© -> ì¸ë±ìŠ¤ ìˆœì„œ)
      - name: Sync Ticker Master
        run: |
          echo "ğŸ“‡ [US] ì¢…ëª© ë§ˆìŠ¤í„° ë™ê¸°í™” ì‹œì‘..."
          curl -X POST https://quantgravity-backend.onrender.com/api/fmp/sync-ticker-master \
          -H "Content-Type: application/json" \
          -H "x-batch-key: ${{ secrets.BATCH_SECRET_KEY }}"

      - name: Sync Index Master
        run: |
          echo "ğŸ“ˆ [US] ì¸ë±ìŠ¤ ë§ˆìŠ¤í„° ë™ê¸°í™” ì‹œì‘..."
          curl -X POST https://quantgravity-backend.onrender.com/api/fmp/sync-index-master \
          -H "Content-Type: application/json" \
          -H "x-batch-key: ${{ secrets.BATCH_SECRET_KEY }}"

      # 2. ë¯¸êµ­ ì£¼ê°€ ì—…ë°ì´íŠ¸
      - name: US Stock Price Update
        timeout-minutes: 15
        run: |
          echo "ğŸš€ [US] ë¯¸êµ­ ì‹œì¥ ì£¼ê°€ ì—…ë°ì´íŠ¸ ì‹œì‘..."
          curl -X POST https://quantgravity-backend.onrender.com/api/fmp/daily-update-all \
          -H "Content-Type: application/json" \
          -H "x-batch-key: ${{ secrets.BATCH_SECRET_KEY }}" \
          -d '{"days": 3, "market": "US"}' 

      # [ì¶”ê°€í•  ë¶€ë¶„] 5ë¶„(300ì´ˆ) ëŒ€ê¸°í•˜ì—¬ ë°±ê·¸ë¼ìš´ë“œ ë°ì´í„° ì €ì¥ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
      - name: Wait for DB Sync
        run: sleep 300

      # 3. í†µê³„ ê°±ì‹ 
      - name: Update Market Stats
        run: |
          echo "ğŸ“Š [US] ë¯¸êµ­ ì‹œì¥ í†µê³„ ì§‘ê³„ ì‹œì‘..."
          curl -X POST https://quantgravity-backend.onrender.com/api/batch/update-stats \
          -H "Content-Type: application/json" \
          -H "x-batch-key: ${{ secrets.BATCH_SECRET_KEY }}" \
          -d '{"country": "US"}'